{{- if and (gt (atoi (include "accelleran.cu-up.upsCount" $)) 0) (gt (atoi (include "accelleran.cu-up.xdpUpsCount" $)) 0) -}}
{{- fail "UPS XDP Interfaces can only be specified if numberOfUpStacks is set to 0" -}}
{{- end -}}

{{- range $ordinal, $xdpUpsInterface := $.Values.xdpUpsInterfaces }}
---
{{ include
      "accelleran.common.deployment"
      (fromYaml (include "accelleran.cu-up.xdp-ups.deployment.args" (list $ $ordinal $xdpUpsInterface)))
}}
{{ end }}


{{- define "accelleran.cu-up.xdp-ups.deployment.args" -}}
{{- $ := first . -}}
{{- $values := index $.Values "xdp-ups" -}}

{{- $ordinal := index . 1 -}}
{{- $xdpUpsInterface := index . 2 -}}

top:
  {{ $ | toYaml | nindent 2 }}
values:
  {{- /* omit nodeName and nodeSelector in original values to give overridden values precedence */ -}}
  {{
    (mergeOverwrite
      (omit (deepCopy $values) "nodeName" "nodeSelector")
      (include "accelleran.cu-up.xdp-ups.deployment.args.values" . | fromYaml)
    ) | toYaml | nindent 2
  }}

name: {{ printf "%s-%d" (include "accelleran.common.fullname" (dict "top" $ "values" $values)) $ordinal }}

env:
  - name: __APPNAME
    value: xdpUps
  - name: __APPID
    valueFrom:
      fieldRef:
        fieldPath: metadata.name
  - name: HOSTMODE
    value: "true"
  - name: IFNAME
    value: {{ $xdpUpsInterface.name | quote }}
  - name: DOWNLINK
    value: {{ $xdpUpsInterface.address | quote }}
  - name: UPLINK
    value: {{ $xdpUpsInterface.address | quote }}
  - name: BIND
    value: {{ $xdpUpsInterface.address | quote }}
  - name: MTU_SIZE
    value: {{ $xdpUpsInterface.mtu | default "1460" | quote }}

envFrom:
  - configMapRef:
      name: {{ include "accelleran.common.bootstrap.configMapName" (dict "top" $) | quote }}
{{- end -}}


{{- define "accelleran.cu-up.xdp-ups.deployment.args.values" -}}
{{- $ := first . -}}
{{- $values := index $.Values "xdp-ups" -}}

{{- $ordinal := index . 1 -}}
{{- $xdpUpsInterface := index . 2 -}}

{{- with $xdpUpsInterface.nodeName }}
nodeName: {{ . }}
{{ end -}}

{{- if $xdpUpsInterface.nodeSelectorOverride -}}
nodeSelector:
  {{ $xdpUpsInterface.nodeSelectorOverride | toYaml | nindent 4 }}
{{- else if or $xdpUpsInterface.nodeSelector (or ($values.nodeSelector) ($.Values.global).nodeSelector)  }}
nodeSelector:
{{- if $values.nodeSelector }}
  {{ $values.nodeSelector | toYaml | nindent 2 }}
{{- else if ($.Values.global).nodeSelector }}
  {{ $.Values.global.nodeSelector | toYaml | nindent 2 }}
{{- end -}}

{{- with $xdpUpsInterface.nodeSelector }}
  {{ . | toYaml | nindent 2 }}
{{- end -}}
{{- end -}}

{{- end -}}
